{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        -352,
        -80
      ],
      "id": "c5c891de-a9d3-4cb8-8ef8-983235c4ae73",
      "name": "When chat message received",
      "webhookId": "25741fcf-63c1-4df2-b517-86c47693d4d7"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=# Query Classification and Email Routing Agent\n\nYou are a query routing agent that classifies incoming queries and sends them to the appropriate team members.\n\n## Workflow\n\n1. **Classify the query** into one of two categories:\n   - **Customer-related**: Product Inquiry, General Support, Sales Question, Billing Inquiry, Feature Request\n   - **Admin-related**: Technical Escalation, System Issue, Security Concern, Data Issue, Integration Problem\n\n2. **Call get_user_data tool** to retrieve all users\n\n3. **Filter users by role**:\n   - Customer-related queries → role: \"customer\"\n   - Admin-related queries → role: \"admin\"\n\n4. **Call send_email tool** for a randomly choosen filtered user with:\n   - emailRecipient: user's email\n   - emailSubject: descriptive subject based on query type\n   - emailBody: the original user query\n\n## Classification Examples\n\n**Customer-related** (route to customers):\n- \"I was charged twice for this month's subscription. Can someone from billing review my account?\"\n- \"What features are included in the Pro plan?\"\n- \"How do I reset my password?\"\n\n**Admin-related** (route to admins):\n- \"URGENT: Our API integration is down and affecting production systems\"\n- \"Security alert: Unusual login attempts detected\"\n- \"Database sync failed - data inconsistency detected\"\n\n## Key Rules\n\n- Look for urgency indicators (URGENT, CRITICAL) and technical terminology for admin classification\n- Create clear email subjects like \"Billing Inquiry\" or \"URGENT: API Integration Issue\"\n- Include the complete original query in emailBody\n- Send emails to ALL users with the matching role\n- When uncertain, consider business impact and technical complexity to classify\n\nExecute the workflow steps in order for every incoming query."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -176,
        -80
      ],
      "id": "1b9babbb-ffb9-490f-931b-25f2990181dd",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "=anthropic.claude-3-sonnet-20240229-v1:0",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAwsBedrock",
      "typeVersion": 1.1,
      "position": [
        -272,
        160
      ],
      "id": "0378d088-a1c4-4a8f-bb0e-b28f2ad15923",
      "name": "AWS Bedrock Chat Model",
      "credentials": {
        "aws": {
          "id": "0C3942Z0HfHWWtWr",
          "name": "AWS (IAM) account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -80,
        176
      ],
      "id": "375fc924-efee-4ef0-8bcb-c0bcf9d2643c",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "toolDescription": "Makes an HTTP GET request to fetch user data with roles",
        "url": "https://api.escuelajs.co/api/v1/users",
        "options": {},
        "optimizeResponse": true,
        "fieldsToInclude": "selected",
        "fields": "email,name,role"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        16,
        176
      ],
      "id": "59ba06fe-030b-4772-b82d-f128b1b84174",
      "name": "get_user_data"
    },
    {
      "parameters": {
        "fromEmail": "santhosh@gmail.com",
        "toEmail": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('To_Email', `The recipient email`, 'string') }}",
        "subject": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Subject', `The subject of the email`, 'string') }}",
        "emailFormat": "text",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Text', `The body of the email`, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSendTool",
      "typeVersion": 2.1,
      "position": [
        128,
        160
      ],
      "id": "80646382-f3a8-4926-9d18-8a23e29ddbcd",
      "name": "send_email",
      "webhookId": "b2924e15-942f-42d9-a6de-5d577c93f383",
      "credentials": {
        "smtp": {
          "id": "QQCB7dl23n0ZuzX5",
          "name": "SMTP account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AWS Bedrock Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        []
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "get_user_data": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "send_email": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "ea33f746-7f4a-4388-9b20-e259d374e723",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ba888b71744914956b0623e4d9a3cd4f6d3633668d513c5eae2fb65477ffa83b"
  },
  "id": "X32lUxKZT57AbR6hzBEZ5",
  "tags": []
}